<?php
/**
 * Created by PhpStorm.
 * User: leodaniel
 * Date: 06.01.18
 * Time: 10:12
 */

namespace le0daniel\System\Console\Commands;

use Carbon\Carbon;
use le0daniel\System\Helpers\Path;
use Symfony\Component\Console\Command\Command;
use Symfony\Component\Console\Exception\RuntimeException;
use Symfony\Component\Console\Input\InputInterface;
use Symfony\Component\Console\Output\OutputInterface;
use Symfony\Component\Console\Question\ChoiceQuestion;
use Symfony\Component\Console\Question\Question;

class GenereatePotFile extends Command {

	/**
	 * Regex to parse twig templates
	 *
	 * @var string
	 */
	//protected $regex = '/{{\s*\'(?<t>.*?)\'\s*\|\s*t(?:.*?)}}/';
	protected $regex = '/{{\s*([\'"])(?<t>.*?)\1\s*\|\s*t(?:.*?)}}/';



	protected function configure()
	{
		$this
			->setName('generate:pot')
			->setDescription('This command should only be runned once')
			->setHelp('This command allows you to generate all files needed when creating a new Theme');
	}

	/**
	 * @param InputInterface $input
	 * @param OutputInterface $output
	 *
	 * @return void
	 */
	protected function execute(InputInterface $input, OutputInterface $output){

		$files = Path::find_recursive(
			Path::activeThemePath('resources/views/*.twig')
		);

		$total_keys = [];

		foreach($files as $file){

			$content = file_get_contents($file);
			preg_match_all($this->regex, $content, $matches, PREG_SET_ORDER, 0);
			$keys = array_column($matches,'t');

			$total_keys[basename($file)] = $keys;
			unset($content);
		}

		$compiled_elements = [];

		/* Generate translation file */
		foreach($total_keys as $filename => $keys){

			if(empty($keys)){
				continue;
			}

			/* Create file header */
			$compiled_elements[] = implode(PHP_EOL,[
				'# --------------'.str_pad('',strlen(basename($filename)),'-'),
				'# File:         '.basename($filename),
				'# Translations: '.count($keys),
				'# --------------'.str_pad('',strlen(basename($filename)),'-'),
				'',
			]);

			/* Compile all elements */
			foreach($keys as $key){
				$compiled_elements[] = $this->compileElement($filename,$key);
			}

		}

		$this->generateFile($compiled_elements,array_keys($total_keys));

	}

	/**
	 * @param string $file
	 * @param string $key
	 *
	 * @return string
	 */
	protected function compileElement(string $file,string $key):string{

		return implode(PHP_EOL,[
			sprintf('#: %s',$file),
			sprintf('msgid "%s"', addslashes( $key ) ),
			'msgstr ""',
			'',
		]);
	}

	/**
	 * @param array $elements
	 * @param array $inspected_files
	 */
	protected function generateFile(array $elements,array $inspected_files){
		/* Get save path */
		$save_path = Path::activeThemePath('resources/lang/'.Path::$theme_dirname.'.pot');

		if(file_exists($save_path)){
			$save_path = $save_path.Carbon::now()->format('Ymd_His').'.pot';
		}

		$max = max( array_merge( array_map('strlen',$inspected_files), [33] ) ) + 2;
		$pad = '# '.str_pad('',$max,'_');

		$header = [
			$pad,
			'# Generated by Nitrosoft WP_system',
			'# Autogenerated, take with caution!',
			'# Date: '.Carbon::now(),
			$pad,
			'# Inspected files: ',
		];

		/* Add Files to header */
		foreach($inspected_files as $file){
			$header[] = '# > '.$file;
		}

		$header = array_merge($header,[
			$pad,
			'',
			'msgid ""',
			'msgstr ""',
			''
		]);

		$header = implode(PHP_EOL,$header);

		$rendered = implode(PHP_EOL,$elements);

		$file = $header.PHP_EOL.$rendered;

		file_put_contents($save_path,$file);
	}

}